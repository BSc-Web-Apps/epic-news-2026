{"version":3,"file":"notes._noteId-BZU4Z_Qd.js","sources":["../../../app/routes/users+/$username_+/notes.$noteId.tsx"],"sourcesContent":["import { getFormProps, useForm } from '@conform-to/react'\nimport { parseWithZod } from '@conform-to/zod'\nimport { invariantResponse } from '@epic-web/invariant'\nimport { formatDistanceToNow } from 'date-fns'\nimport { Img } from 'openimg/react'\nimport { useRef, useEffect } from 'react'\nimport { data, Form, Link } from 'react-router'\nimport { z } from 'zod'\nimport { GeneralErrorBoundary } from '#app/components/error-boundary.tsx'\nimport { floatingToolbarClassName } from '#app/components/floating-toolbar.tsx'\nimport { ErrorList } from '#app/components/forms.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { prisma } from '#app/utils/db.server.ts'\nimport { getNoteImgSrc, useIsPending } from '#app/utils/misc.tsx'\nimport { requireUserWithPermission } from '#app/utils/permissions.server.ts'\nimport { redirectWithToast } from '#app/utils/toast.server.ts'\nimport { userHasPermission, useOptionalUser } from '#app/utils/user.ts'\nimport { type Route } from './+types/notes.$noteId.ts'\nimport { type Route as NotesRoute } from './+types/notes.ts'\n\nexport async function loader({ params }: Route.LoaderArgs) {\n\tconst note = await prisma.note.findUnique({\n\t\twhere: { id: params.noteId },\n\t\tselect: {\n\t\t\tid: true,\n\t\t\ttitle: true,\n\t\t\tcontent: true,\n\t\t\townerId: true,\n\t\t\tupdatedAt: true,\n\t\t\timages: {\n\t\t\t\tselect: {\n\t\t\t\t\taltText: true,\n\t\t\t\t\tobjectKey: true,\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t})\n\n\tinvariantResponse(note, 'Not found', { status: 404 })\n\n\tconst date = new Date(note.updatedAt)\n\tconst timeAgo = formatDistanceToNow(date)\n\n\treturn { note, timeAgo }\n}\n\nconst DeleteFormSchema = z.object({\n\tintent: z.literal('delete-note'),\n\tnoteId: z.string(),\n})\n\nexport async function action({ request }: Route.ActionArgs) {\n\tconst userId = await requireUserId(request)\n\tconst formData = await request.formData()\n\tconst submission = parseWithZod(formData, {\n\t\tschema: DeleteFormSchema,\n\t})\n\tif (submission.status !== 'success') {\n\t\treturn data(\n\t\t\t{ result: submission.reply() },\n\t\t\t{ status: submission.status === 'error' ? 400 : 200 },\n\t\t)\n\t}\n\n\tconst { noteId } = submission.value\n\n\tconst note = await prisma.note.findFirst({\n\t\tselect: { id: true, ownerId: true, owner: { select: { username: true } } },\n\t\twhere: { id: noteId },\n\t})\n\tinvariantResponse(note, 'Not found', { status: 404 })\n\n\tconst isOwner = note.ownerId === userId\n\tawait requireUserWithPermission(\n\t\trequest,\n\t\tisOwner ? `delete:note:own` : `delete:note:any`,\n\t)\n\n\tawait prisma.note.delete({ where: { id: note.id } })\n\n\treturn redirectWithToast(`/users/${note.owner.username}/notes`, {\n\t\ttype: 'success',\n\t\ttitle: 'Success',\n\t\tdescription: 'Your note has been deleted.',\n\t})\n}\n\nexport default function NoteRoute({\n\tloaderData,\n\tactionData,\n}: Route.ComponentProps) {\n\tconst user = useOptionalUser()\n\tconst isOwner = user?.id === loaderData.note.ownerId\n\tconst canDelete = userHasPermission(\n\t\tuser,\n\t\tisOwner ? `delete:note:own` : `delete:note:any`,\n\t)\n\tconst displayBar = canDelete || isOwner\n\n\t// Add ref for auto-focusing\n\tconst sectionRef = useRef<HTMLElement>(null)\n\n\t// Focus the section when the note ID changes\n\tuseEffect(() => {\n\t\tif (sectionRef.current) {\n\t\t\tsectionRef.current.focus()\n\t\t}\n\t}, [loaderData.note.id])\n\n\treturn (\n\t\t<section\n\t\t\tref={sectionRef}\n\t\t\tclassName=\"absolute inset-0 flex flex-col px-10\"\n\t\t\taria-labelledby=\"note-title\"\n\t\t\ttabIndex={-1} // Make the section focusable without keyboard navigation\n\t\t>\n\t\t\t<h2 id=\"note-title\" className=\"text-h2 mb-2 pt-12 lg:mb-6\">\n\t\t\t\t{loaderData.note.title}\n\t\t\t</h2>\n\t\t\t<div className={`${displayBar ? 'pb-24' : 'pb-12'} overflow-y-auto`}>\n\t\t\t\t<ul className=\"flex flex-wrap gap-5 py-5\">\n\t\t\t\t\t{loaderData.note.images.map((image) => (\n\t\t\t\t\t\t<li key={image.objectKey}>\n\t\t\t\t\t\t\t<a href={getNoteImgSrc(image.objectKey)}>\n\t\t\t\t\t\t\t\t<Img\n\t\t\t\t\t\t\t\t\tsrc={getNoteImgSrc(image.objectKey)}\n\t\t\t\t\t\t\t\t\talt={image.altText ?? ''}\n\t\t\t\t\t\t\t\t\tclassName=\"size-32 rounded-lg object-cover\"\n\t\t\t\t\t\t\t\t\twidth={512}\n\t\t\t\t\t\t\t\t\theight={512}\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t))}\n\t\t\t\t</ul>\n\t\t\t\t<p className=\"text-sm whitespace-break-spaces md:text-lg\">\n\t\t\t\t\t{loaderData.note.content}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t\t{displayBar ? (\n\t\t\t\t<div className={floatingToolbarClassName}>\n\t\t\t\t\t<span className=\"text-foreground/90 text-sm max-[524px]:hidden\">\n\t\t\t\t\t\t<Icon name=\"clock\" className=\"scale-125\">\n\t\t\t\t\t\t\t{loaderData.timeAgo} ago\n\t\t\t\t\t\t</Icon>\n\t\t\t\t\t</span>\n\t\t\t\t\t<div className=\"grid flex-1 grid-cols-2 justify-end gap-2 min-[525px]:flex md:gap-4\">\n\t\t\t\t\t\t{canDelete ? (\n\t\t\t\t\t\t\t<DeleteNote id={loaderData.note.id} actionData={actionData} />\n\t\t\t\t\t\t) : null}\n\t\t\t\t\t\t<Button\n\t\t\t\t\t\t\tasChild\n\t\t\t\t\t\t\tclassName=\"min-[525px]:max-md:aspect-square min-[525px]:max-md:px-0\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Link to=\"edit\">\n\t\t\t\t\t\t\t\t<Icon name=\"pencil-1\" className=\"scale-125 max-md:scale-150\">\n\t\t\t\t\t\t\t\t\t<span className=\"max-md:hidden\">Edit</span>\n\t\t\t\t\t\t\t\t</Icon>\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</Button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t) : null}\n\t\t</section>\n\t)\n}\n\nexport function DeleteNote({\n\tid,\n\tactionData,\n}: {\n\tid: string\n\tactionData: Route.ComponentProps['actionData'] | undefined\n}) {\n\tconst isPending = useIsPending()\n\tconst [form] = useForm({\n\t\tid: 'delete-note',\n\t\tlastResult: actionData?.result,\n\t})\n\n\treturn (\n\t\t<Form method=\"POST\" {...getFormProps(form)}>\n\t\t\t<input type=\"hidden\" name=\"noteId\" value={id} />\n\t\t\t<StatusButton\n\t\t\t\ttype=\"submit\"\n\t\t\t\tname=\"intent\"\n\t\t\t\tvalue=\"delete-note\"\n\t\t\t\tvariant=\"destructive\"\n\t\t\t\tstatus={isPending ? 'pending' : (form.status ?? 'idle')}\n\t\t\t\tdisabled={isPending}\n\t\t\t\tclassName=\"w-full max-md:aspect-square max-md:px-0\"\n\t\t\t>\n\t\t\t\t<Icon name=\"trash\" className=\"scale-125 max-md:scale-150\">\n\t\t\t\t\t<span className=\"max-md:hidden\">Delete</span>\n\t\t\t\t</Icon>\n\t\t\t</StatusButton>\n\t\t\t<ErrorList errors={form.errors} id={form.errorId} />\n\t\t</Form>\n\t)\n}\n\nexport const meta: Route.MetaFunction = ({ data, params, matches }) => {\n\tconst notesMatch = matches.find(\n\t\t(m) => m?.id === 'routes/users+/$username_+/notes',\n\t) as { data: NotesRoute.ComponentProps['loaderData'] } | undefined\n\n\tconst displayName = notesMatch?.data?.owner.name ?? params.username\n\tconst noteTitle = data?.note.title ?? 'Note'\n\tconst noteContentsSummary =\n\t\tdata && data.note.content.length > 100\n\t\t\t? data?.note.content.slice(0, 97) + '...'\n\t\t\t: 'No content'\n\treturn [\n\t\t{ title: `${noteTitle} | ${displayName}'s Notes | Epic Notes` },\n\t\t{\n\t\t\tname: 'description',\n\t\t\tcontent: noteContentsSummary,\n\t\t},\n\t]\n}\n\nexport function ErrorBoundary() {\n\treturn (\n\t\t<GeneralErrorBoundary\n\t\t\tstatusHandlers={{\n\t\t\t\t403: () => <p>You are not allowed to do that</p>,\n\t\t\t\t404: ({ params }) => (\n\t\t\t\t\t<p>No note with the id \"{params.noteId}\" exists</p>\n\t\t\t\t),\n\t\t\t}}\n\t\t/>\n\t)\n}\n"],"names":["notes_$noteId","_UNSAFE_withComponentProps","loaderData","actionData","user","useOptionalUser","isOwner","id","note","ownerId","canDelete","userHasPermission","displayBar","sectionRef","useRef","useEffect","current","focus","jsxs","ref","className","tabIndex","children","jsx","title","images","map","image","href","getNoteImgSrc","objectKey","Img","src","alt","altText","width","height","content","floatingToolbarClassName","Icon","name","timeAgo","DeleteNote","Button","asChild","Link","to","isPending","useIsPending","form","useForm","lastResult","result","Form","method","getFormProps","type","value","StatusButton","variant","status","disabled","ErrorList","errors","errorId","meta","data","params","matches","displayName","find","m","owner","username","noteTitle","noteContentsSummary","length","slice","ErrorBoundary","_UNSAFE_withErrorBoundaryProps","GeneralErrorBoundary","statusHandlers","noteId"],"mappings":"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"}