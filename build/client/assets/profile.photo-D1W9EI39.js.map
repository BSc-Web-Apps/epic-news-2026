{"version":3,"file":"profile.photo-D1W9EI39.js","sources":["../../../app/routes/settings+/profile.photo.tsx"],"sourcesContent":["import { getFormProps, getInputProps, useForm } from '@conform-to/react'\nimport { getZodConstraint, parseWithZod } from '@conform-to/zod'\nimport { invariantResponse } from '@epic-web/invariant'\nimport { parseFormData } from '@mjackson/form-data-parser'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport { useState } from 'react'\nimport { data, redirect, Form, useNavigation } from 'react-router'\nimport { z } from 'zod'\nimport { ErrorList } from '#app/components/forms.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport { Icon } from '#app/components/ui/icon.tsx'\nimport { StatusButton } from '#app/components/ui/status-button.tsx'\nimport { requireUserId } from '#app/utils/auth.server.ts'\nimport { prisma } from '#app/utils/db.server.ts'\nimport {\n\tgetUserImgSrc,\n\tuseDoubleCheck,\n\tuseIsPending,\n} from '#app/utils/misc.tsx'\nimport { uploadProfileImage } from '#app/utils/storage.server.ts'\nimport { type Route } from './+types/profile.photo.ts'\nimport { type BreadcrumbHandle } from './profile.tsx'\n\nexport const handle: BreadcrumbHandle & SEOHandle = {\n\tbreadcrumb: <Icon name=\"avatar\">Photo</Icon>,\n\tgetSitemapEntries: () => null,\n}\n\nconst MAX_SIZE = 1024 * 1024 * 3 // 3MB\n\nconst DeleteImageSchema = z.object({\n\tintent: z.literal('delete'),\n})\n\nconst NewImageSchema = z.object({\n\tintent: z.literal('submit'),\n\tphotoFile: z\n\t\t.instanceof(File)\n\t\t.refine((file) => file.size > 0, 'Image is required')\n\t\t.refine(\n\t\t\t(file) => file.size <= MAX_SIZE,\n\t\t\t'Image size must be less than 3MB',\n\t\t),\n})\n\nconst PhotoFormSchema = z.discriminatedUnion('intent', [\n\tDeleteImageSchema,\n\tNewImageSchema,\n])\n\nexport async function loader({ request }: Route.LoaderArgs) {\n\tconst userId = await requireUserId(request)\n\tconst user = await prisma.user.findUnique({\n\t\twhere: { id: userId },\n\t\tselect: {\n\t\t\tid: true,\n\t\t\tname: true,\n\t\t\tusername: true,\n\t\t\timage: { select: { objectKey: true } },\n\t\t},\n\t})\n\tinvariantResponse(user, 'User not found', { status: 404 })\n\treturn { user }\n}\n\nexport async function action({ request }: Route.ActionArgs) {\n\tconst userId = await requireUserId(request)\n\n\tconst formData = await parseFormData(request, { maxFileSize: MAX_SIZE })\n\tconst submission = await parseWithZod(formData, {\n\t\tschema: PhotoFormSchema.transform(async (data) => {\n\t\t\tif (data.intent === 'delete') return { intent: 'delete' }\n\t\t\tif (data.photoFile.size <= 0) return z.NEVER\n\t\t\treturn {\n\t\t\t\tintent: data.intent,\n\t\t\t\timage: {\n\t\t\t\t\tobjectKey: await uploadProfileImage(userId, data.photoFile),\n\t\t\t\t},\n\t\t\t}\n\t\t}),\n\t\tasync: true,\n\t})\n\n\tif (submission.status !== 'success') {\n\t\treturn data(\n\t\t\t{ result: submission.reply() },\n\t\t\t{ status: submission.status === 'error' ? 400 : 200 },\n\t\t)\n\t}\n\n\tconst { image, intent } = submission.value\n\n\tif (intent === 'delete') {\n\t\tawait prisma.userImage.deleteMany({ where: { userId } })\n\t\treturn redirect('/settings/profile')\n\t}\n\n\tawait prisma.$transaction(async ($prisma) => {\n\t\tawait $prisma.userImage.deleteMany({ where: { userId } })\n\t\tawait $prisma.user.update({\n\t\t\twhere: { id: userId },\n\t\t\tdata: { image: { create: image } },\n\t\t})\n\t})\n\n\treturn redirect('/settings/profile')\n}\n\nexport default function PhotoRoute({\n\tloaderData,\n\tactionData,\n}: Route.ComponentProps) {\n\tconst doubleCheckDeleteImage = useDoubleCheck()\n\n\tconst navigation = useNavigation()\n\n\tconst [form, fields] = useForm({\n\t\tid: 'profile-photo',\n\t\tconstraint: getZodConstraint(PhotoFormSchema),\n\t\tlastResult: actionData?.result,\n\t\tonValidate({ formData }) {\n\t\t\treturn parseWithZod(formData, { schema: PhotoFormSchema })\n\t\t},\n\t\tshouldRevalidate: 'onBlur',\n\t})\n\n\tconst isPending = useIsPending()\n\tconst pendingIntent = isPending ? navigation.formData?.get('intent') : null\n\tconst lastSubmissionIntent = fields.intent.value\n\n\tconst [newImageSrc, setNewImageSrc] = useState<string | null>(null)\n\n\treturn (\n\t\t<div>\n\t\t\t<Form\n\t\t\t\tmethod=\"POST\"\n\t\t\t\tencType=\"multipart/form-data\"\n\t\t\t\tclassName=\"flex flex-col items-center justify-center gap-10\"\n\t\t\t\tonReset={() => setNewImageSrc(null)}\n\t\t\t\t{...getFormProps(form)}\n\t\t\t>\n\t\t\t\t<img\n\t\t\t\t\tsrc={\n\t\t\t\t\t\tnewImageSrc ??\n\t\t\t\t\t\t(loaderData.user\n\t\t\t\t\t\t\t? getUserImgSrc(loaderData.user.image?.objectKey)\n\t\t\t\t\t\t\t: '')\n\t\t\t\t\t}\n\t\t\t\t\tclassName=\"size-52 rounded-full object-cover\"\n\t\t\t\t\talt={loaderData.user?.name ?? loaderData.user?.username}\n\t\t\t\t/>\n\t\t\t\t<ErrorList errors={fields.photoFile.errors} id={fields.photoFile.id} />\n\t\t\t\t<div className=\"flex gap-4\">\n\t\t\t\t\t{/*\n\t\t\t\t\t\tWe're doing some kinda odd things to make it so this works well\n\t\t\t\t\t\twithout JavaScript. Basically, we're using CSS to ensure the right\n\t\t\t\t\t\tbuttons show up based on the input's \"valid\" state (whether or not\n\t\t\t\t\t\tan image has been selected). Progressive enhancement FTW!\n\t\t\t\t\t*/}\n\t\t\t\t\t<input\n\t\t\t\t\t\t{...getInputProps(fields.photoFile, { type: 'file' })}\n\t\t\t\t\t\taccept=\"image/*\"\n\t\t\t\t\t\tclassName=\"peer sr-only\"\n\t\t\t\t\t\trequired\n\t\t\t\t\t\ttabIndex={newImageSrc ? -1 : 0}\n\t\t\t\t\t\tonChange={(e) => {\n\t\t\t\t\t\t\tconst file = e.currentTarget.files?.[0]\n\t\t\t\t\t\t\tif (file) {\n\t\t\t\t\t\t\t\tconst reader = new FileReader()\n\t\t\t\t\t\t\t\treader.onload = (event) => {\n\t\t\t\t\t\t\t\t\tsetNewImageSrc(event.target?.result?.toString() ?? null)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\treader.readAsDataURL(file)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tasChild\n\t\t\t\t\t\tclassName=\"cursor-pointer peer-valid:hidden peer-focus-within:ring-2 peer-focus-visible:ring-2\"\n\t\t\t\t\t>\n\t\t\t\t\t\t<label htmlFor={fields.photoFile.id}>\n\t\t\t\t\t\t\t<Icon name=\"pencil-1\">Change</Icon>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</Button>\n\t\t\t\t\t<StatusButton\n\t\t\t\t\t\tname=\"intent\"\n\t\t\t\t\t\tvalue=\"submit\"\n\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\tclassName=\"peer-invalid:hidden\"\n\t\t\t\t\t\tstatus={\n\t\t\t\t\t\t\tpendingIntent === 'submit'\n\t\t\t\t\t\t\t\t? 'pending'\n\t\t\t\t\t\t\t\t: lastSubmissionIntent === 'submit'\n\t\t\t\t\t\t\t\t\t? (form.status ?? 'idle')\n\t\t\t\t\t\t\t\t\t: 'idle'\n\t\t\t\t\t\t}\n\t\t\t\t\t>\n\t\t\t\t\t\tSave Photo\n\t\t\t\t\t</StatusButton>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tvariant=\"destructive\"\n\t\t\t\t\t\tclassName=\"peer-invalid:hidden\"\n\t\t\t\t\t\t{...form.reset.getButtonProps()}\n\t\t\t\t\t>\n\t\t\t\t\t\t<Icon name=\"trash\">Reset</Icon>\n\t\t\t\t\t</Button>\n\t\t\t\t\t{loaderData.user.image ? (\n\t\t\t\t\t\t<StatusButton\n\t\t\t\t\t\t\tclassName=\"peer-valid:hidden\"\n\t\t\t\t\t\t\tvariant=\"destructive\"\n\t\t\t\t\t\t\t{...doubleCheckDeleteImage.getButtonProps({\n\t\t\t\t\t\t\t\ttype: 'submit',\n\t\t\t\t\t\t\t\tname: 'intent',\n\t\t\t\t\t\t\t\tvalue: 'delete',\n\t\t\t\t\t\t\t})}\n\t\t\t\t\t\t\tstatus={\n\t\t\t\t\t\t\t\tpendingIntent === 'delete'\n\t\t\t\t\t\t\t\t\t? 'pending'\n\t\t\t\t\t\t\t\t\t: lastSubmissionIntent === 'delete'\n\t\t\t\t\t\t\t\t\t\t? (form.status ?? 'idle')\n\t\t\t\t\t\t\t\t\t\t: 'idle'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Icon name=\"trash\">\n\t\t\t\t\t\t\t\t{doubleCheckDeleteImage.doubleCheck\n\t\t\t\t\t\t\t\t\t? 'Are you sure?'\n\t\t\t\t\t\t\t\t\t: 'Delete'}\n\t\t\t\t\t\t\t</Icon>\n\t\t\t\t\t\t</StatusButton>\n\t\t\t\t\t) : null}\n\t\t\t\t</div>\n\t\t\t\t<ErrorList errors={form.errors} />\n\t\t\t</Form>\n\t\t</div>\n\t)\n}\n"],"names":["handle","breadcrumb","jsx","Icon","name","children","getSitemapEntries","MAX_SIZE","DeleteImageSchema","z","intent","NewImageSchema","photoFile","File","refine","file","size","PhotoFormSchema","profile_photo","_UNSAFE_withComponentProps","loaderData","actionData","doubleCheckDeleteImage","useDoubleCheck","navigation","useNavigation","form","fields","useForm","id","constraint","getZodConstraint","lastResult","result","onValidate","formData","parseWithZod","schema","shouldRevalidate","pendingIntent","useIsPending","get","lastSubmissionIntent","value","newImageSrc","setNewImageSrc","useState","jsxs","Form","method","encType","className","onReset","getFormProps","src","user","getUserImgSrc","image","objectKey","alt","username","ErrorList","errors","getInputProps","type","accept","required","tabIndex","onChange","e","currentTarget","files","reader","FileReader","onload","event","target","toString","readAsDataURL","Button","asChild","htmlFor","StatusButton","status","variant","reset","getButtonProps","doubleCheck"],"mappings":"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"}