import{w as C,a as k,b as L,j as e,F as _,L as E,r as j,m as D}from"./chunk-UH6JLGW7-vC5r3Eub.js";import{b as S,W as d,i as F,t as B,a as U,c as W,d as p,e as H}from"./toAuthenticatorAttachment-BAxCDoik.js";import{H as J}from"./honeypot-B1mKHLUw.js";import{G as M}from"./error-boundary-DyX_TQyi.js";import{F as N,C as K,E as v}from"./forms-D7XpjJLD.js";import{S as V}from"./spacer-CWmOD1GL.js";import{I as G}from"./icon-C3K2m46L.js";import{S as T}from"./status-button-hfmu5Em_.js";import{p as $,P as q}from"./connections-BLqavkLQ.js";import{b as Y,f as z}from"./misc-CB38qpgG.js";import{P as Z,U as Q}from"./user-validation-CltVSBa4.js";import{u as X,g as ee,a as g}from"./helpers-Ch5Ym2hM.js";import{g as te}from"./constraint-cuuFo8uo.js";import{p as se}from"./parse-Bbiqquwr.js";import{o as m,d as re,s as w,l as A,c as oe}from"./types-kDhgxygl.js";import"./debug-build-DiXn8T-e.js";import"./index-Bn1b60ek.js";import"./index-C2xojAqc.js";import"./index-BlK1szso.js";import"./dom--0h4o3Zv.js";import"./button-BP3wkmPp.js";import"./tooltip-fkOurSWR.js";function ae(){if(!S())return R.stubThis(new Promise(r=>r(!1)));const t=globalThis.PublicKeyCredential;return t?.isConditionalMediationAvailable===void 0?R.stubThis(new Promise(r=>r(!1))):R.stubThis(t.isConditionalMediationAvailable())}const R={stubThis:t=>t};function ne({error:t,options:r}){const{publicKey:a}=r;if(!a)throw Error("options was missing required publicKey property");if(t.name==="AbortError"){if(r.signal instanceof AbortSignal)return new d({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:t})}else{if(t.name==="NotAllowedError")return new d({message:t.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t});if(t.name==="SecurityError"){const i=globalThis.location.hostname;if(F(i)){if(a.rpId!==i)return new d({message:`The RP ID "${a.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:t})}else return new d({message:`${globalThis.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:t})}else if(t.name==="UnknownError")return new d({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:t})}return t}async function ie(t){!t.optionsJSON&&t.challenge&&(console.warn("startAuthentication() was not called correctly. It will try to continue with the provided options, but this call should be refactored to use the expected call structure instead. See https://simplewebauthn.dev/docs/packages/browser#typeerror-cannot-read-properties-of-undefined-reading-challenge for more information."),t={optionsJSON:t});const{optionsJSON:r,useBrowserAutofill:a=!1,verifyBrowserAutofillInput:i=!0}=t;if(!S())throw new Error("WebAuthn is not supported in this browser");let n;r.allowCredentials?.length!==0&&(n=r.allowCredentials?.map(B));const l={...r,challenge:U(r.challenge),allowCredentials:n},s={};if(a){if(!await ae())throw Error("Browser does not support WebAuthn autofill");if(document.querySelectorAll("input[autocomplete$='webauthn']").length<1&&i)throw Error('No <input> with "webauthn" as the only or last value in its `autocomplete` attribute was detected');s.mediation="conditional",l.allowCredentials=[]}s.publicKey=l,s.signal=W.createNewAbortSignal();let o;try{o=await navigator.credentials.get(s)}catch(y){throw ne({error:y,options:s})}if(!o)throw new Error("Authentication was not completed");const{id:b,rawId:h,response:c,type:x}=o;let f;return c.userHandle&&(f=p(c.userHandle)),{id:b,rawId:p(h),response:{authenticatorData:p(c.authenticatorData),clientDataJSON:p(c.clientDataJSON),signature:p(c.signature),userHandle:f},type:x,clientExtensionResults:o.getClientExtensionResults(),authenticatorAttachment:H(o.authenticatorAttachment)}}const ke={getSitemapEntries:()=>null},P=m({username:Q,password:Z,redirectTo:w().optional(),remember:oe().optional()}),le=m({options:m({challenge:w()})}),Le=C(function({actionData:r}){const a=Y(),[i]=L(),n=i.get("redirectTo"),[l,s]=X({id:"login-form",constraint:te(P),defaultValue:{redirectTo:n},lastResult:r?.result,onValidate({formData:o}){return se(o,{schema:P})},shouldRevalidate:"onBlur"});return e.jsx("div",{className:"flex min-h-full flex-col justify-center pt-20 pb-32",children:e.jsxs("div",{className:"mx-auto w-full max-w-md",children:[e.jsxs("div",{className:"flex flex-col gap-3 text-center",children:[e.jsx("h1",{className:"text-h1",children:"Welcome back!"}),e.jsx("p",{className:"text-body-md text-muted-foreground",children:"Please enter your details."})]}),e.jsx(V,{size:"xs"}),e.jsx("div",{children:e.jsxs("div",{className:"mx-auto w-full max-w-md px-8",children:[e.jsxs(_,{method:"POST",...ee(l),children:[e.jsx(J,{}),e.jsx(N,{labelProps:{children:"Username"},inputProps:{...g(s.username,{type:"text"}),autoFocus:!0,className:"lowercase",autoComplete:"username"},errors:s.username.errors}),e.jsx(N,{labelProps:{children:"Password"},inputProps:{...g(s.password,{type:"password"}),autoComplete:"current-password"},errors:s.password.errors}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(K,{labelProps:{htmlFor:s.remember.id,children:"Remember me"},buttonProps:g(s.remember,{type:"checkbox"}),errors:s.remember.errors}),e.jsx("div",{children:e.jsx(E,{to:"/forgot-password",className:"text-body-xs font-semibold",children:"Forgot password?"})})]}),e.jsx("input",{...g(s.redirectTo,{type:"hidden"})}),e.jsx(v,{errors:l.errors,id:l.errorId}),e.jsx("div",{className:"flex items-center justify-between gap-6 pt-3",children:e.jsx(T,{className:"w-full",status:a?"pending":l.status??"idle",type:"submit",disabled:a,children:"Log in"})})]}),e.jsx("hr",{className:"my-4"}),e.jsx("div",{className:"flex flex-col gap-5",children:e.jsx(ue,{redirectTo:n,remember:s.remember.value==="on"})}),e.jsx("hr",{className:"my-4"}),e.jsx("ul",{className:"flex flex-col gap-5",children:$.map(o=>e.jsx("li",{children:e.jsx(q,{type:"Login",providerName:o,redirectTo:n})},o))}),e.jsxs("div",{className:"flex items-center justify-center gap-2 pt-6",children:[e.jsx("span",{className:"text-muted-foreground",children:"New here?"}),e.jsx(E,{to:n?`/signup?redirectTo=${encodeURIComponent(n)}`:"/signup",children:"Create an account"})]})]})})]})})}),ce=re("status",[m({status:A("success"),location:w()}),m({status:A("error"),error:w()})]);function ue({redirectTo:t,remember:r}){const[a]=j.useTransition(),[i,n]=j.useState(null),[l,s]=j.useOptimistic("Login with a passkey"),o=D();async function b(){try{s("Generating Authentication Options");const c=await(await fetch("/webauthn/authentication")).json(),{options:x}=le.parse(c);s("Requesting your authorization");const f=await ie({optionsJSON:x});s("Verifying your passkey");const O=await(await fetch("/webauthn/authentication",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({authResponse:f,remember:r,redirectTo:t})})).json().catch(()=>({status:"error",error:"Unknown error"})),u=ce.safeParse(O);if(u.success){if(u.data.status==="error")throw new Error(u.data.error)}else throw new Error(u.error.message);const{location:I}=u.data;s("You're logged in! Navigating..."),await o(I??"/")}catch(h){const c=z(h);n(`Failed to authenticate with passkey: ${c}`)}}return e.jsxs("form",{action:b,children:[e.jsx(T,{id:"passkey-login-button","aria-describedby":"passkey-login-button-error",className:"w-full",status:a?"pending":i?"error":"idle",type:"submit",disabled:a,children:e.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[e.jsx(G,{name:"passkey"}),e.jsx("span",{children:l})]})}),e.jsx("div",{className:"mt-2",children:e.jsx(v,{errors:[i],id:"passkey-login-button-error"})})]})}const _e=()=>[{title:"Login to Epic Notes"}],De=k(function(){return e.jsx(M,{})});export{De as ErrorBoundary,Le as default,ke as handle,_e as meta};
//# sourceMappingURL=login-DfKBiyJ9.js.map
