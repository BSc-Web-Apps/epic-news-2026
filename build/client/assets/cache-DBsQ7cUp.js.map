{"version":3,"file":"cache-DBsQ7cUp.js","sources":["../../../app/routes/admin+/cache.tsx"],"sourcesContent":["import { invariantResponse } from '@epic-web/invariant'\nimport { type SEOHandle } from '@nasa-gcn/remix-seo'\nimport {\n\tredirect,\n\tForm,\n\tLink,\n\tuseFetcher,\n\tuseSearchParams,\n\tuseSubmit,\n} from 'react-router'\nimport { GeneralErrorBoundary } from '#app/components/error-boundary'\nimport { Field } from '#app/components/forms.tsx'\nimport { Spacer } from '#app/components/spacer.tsx'\nimport { Button } from '#app/components/ui/button.tsx'\nimport {\n\tcache,\n\tgetAllCacheKeys,\n\tlruCache,\n\tsearchCacheKeys,\n} from '#app/utils/cache.server.ts'\nimport {\n\tensureInstance,\n\tgetAllInstances,\n\tgetInstanceInfo,\n} from '#app/utils/litefs.server.ts'\nimport { useDebounce, useDoubleCheck } from '#app/utils/misc.tsx'\nimport { requireUserWithRole } from '#app/utils/permissions.server.ts'\nimport { type Route } from './+types/cache.ts'\n\nexport const handle: SEOHandle = {\n\tgetSitemapEntries: () => null,\n}\n\nexport async function loader({ request }: Route.LoaderArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst searchParams = new URL(request.url).searchParams\n\tconst query = searchParams.get('query')\n\tif (query === '') {\n\t\tsearchParams.delete('query')\n\t\treturn redirect(`/admin/cache?${searchParams.toString()}`)\n\t}\n\tconst limit = Number(searchParams.get('limit') ?? 100)\n\n\tconst currentInstanceInfo = await getInstanceInfo()\n\tconst instance =\n\t\tsearchParams.get('instance') ?? currentInstanceInfo.currentInstance\n\tconst instances = await getAllInstances()\n\tawait ensureInstance(instance)\n\n\tlet cacheKeys: { sqlite: Array<string>; lru: Array<string> }\n\tif (typeof query === 'string') {\n\t\tcacheKeys = await searchCacheKeys(query, limit)\n\t} else {\n\t\tcacheKeys = await getAllCacheKeys(limit)\n\t}\n\treturn { cacheKeys, instance, instances, currentInstanceInfo }\n}\n\nexport async function action({ request }: Route.ActionArgs) {\n\tawait requireUserWithRole(request, 'admin')\n\tconst formData = await request.formData()\n\tconst key = formData.get('cacheKey')\n\tconst { currentInstance } = await getInstanceInfo()\n\tconst instance = formData.get('instance') ?? currentInstance\n\tconst type = formData.get('type')\n\n\tinvariantResponse(typeof key === 'string', 'cacheKey must be a string')\n\tinvariantResponse(typeof type === 'string', 'type must be a string')\n\tinvariantResponse(typeof instance === 'string', 'instance must be a string')\n\tawait ensureInstance(instance)\n\n\tswitch (type) {\n\t\tcase 'sqlite': {\n\t\t\tawait cache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tcase 'lru': {\n\t\t\tlruCache.delete(key)\n\t\t\tbreak\n\t\t}\n\t\tdefault: {\n\t\t\tthrow new Error(`Unknown cache type: ${type}`)\n\t\t}\n\t}\n\treturn { success: true }\n}\n\nexport default function CacheAdminRoute({ loaderData }: Route.ComponentProps) {\n\tconst [searchParams] = useSearchParams()\n\tconst submit = useSubmit()\n\tconst query = searchParams.get('query') ?? ''\n\tconst limit = searchParams.get('limit') ?? '100'\n\tconst instance = searchParams.get('instance') ?? loaderData.instance\n\n\tconst handleFormChange = useDebounce(async (form: HTMLFormElement) => {\n\t\tawait submit(form)\n\t}, 400)\n\n\treturn (\n\t\t<div className=\"container\">\n\t\t\t<h1 className=\"text-h1\">Cache Admin</h1>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<Form\n\t\t\t\tmethod=\"get\"\n\t\t\t\tclassName=\"flex flex-col gap-4\"\n\t\t\t\tonChange={(e) => handleFormChange(e.currentTarget)}\n\t\t\t>\n\t\t\t\t<div className=\"flex-1\">\n\t\t\t\t\t<div className=\"flex flex-1 gap-4\">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype=\"submit\"\n\t\t\t\t\t\t\tclassName=\"flex h-16 items-center justify-center\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tðŸ”Ž\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<Field\n\t\t\t\t\t\t\tclassName=\"flex-1\"\n\t\t\t\t\t\t\tlabelProps={{ children: 'Search' }}\n\t\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\t\ttype: 'search',\n\t\t\t\t\t\t\t\tname: 'query',\n\t\t\t\t\t\t\t\tdefaultValue: query,\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div className=\"text-muted-foreground flex h-16 w-14 items-center text-lg font-medium\">\n\t\t\t\t\t\t\t<span title=\"Total results shown\">\n\t\t\t\t\t\t\t\t{loaderData.cacheKeys.sqlite.length +\n\t\t\t\t\t\t\t\t\tloaderData.cacheKeys.lru.length}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"flex flex-wrap items-center gap-4\">\n\t\t\t\t\t<Field\n\t\t\t\t\t\tlabelProps={{\n\t\t\t\t\t\t\tchildren: 'Limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t\tinputProps={{\n\t\t\t\t\t\t\tname: 'limit',\n\t\t\t\t\t\t\tdefaultValue: limit,\n\t\t\t\t\t\t\ttype: 'number',\n\t\t\t\t\t\t\tstep: '1',\n\t\t\t\t\t\t\tmin: '1',\n\t\t\t\t\t\t\tmax: '10000',\n\t\t\t\t\t\t\tplaceholder: 'results limit',\n\t\t\t\t\t\t}}\n\t\t\t\t\t/>\n\t\t\t\t\t<select name=\"instance\" defaultValue={instance}>\n\t\t\t\t\t\t{Object.entries(loaderData.instances).map(([inst, region]) => (\n\t\t\t\t\t\t\t<option key={inst} value={inst}>\n\t\t\t\t\t\t\t\t{[\n\t\t\t\t\t\t\t\t\tinst,\n\t\t\t\t\t\t\t\t\t`(${region})`,\n\t\t\t\t\t\t\t\t\tinst === loaderData.currentInstanceInfo.currentInstance\n\t\t\t\t\t\t\t\t\t\t? '(current)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t\tinst === loaderData.currentInstanceInfo.primaryInstance\n\t\t\t\t\t\t\t\t\t\t? ' (primary)'\n\t\t\t\t\t\t\t\t\t\t: '',\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t\t\t.filter(Boolean)\n\t\t\t\t\t\t\t\t\t.join(' ')}\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t))}\n\t\t\t\t\t</select>\n\t\t\t\t</div>\n\t\t\t</Form>\n\t\t\t<Spacer size=\"2xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">LRU Cache:</h2>\n\t\t\t\t{loaderData.cacheKeys.lru.map((key) => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"lru\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t\t<Spacer size=\"3xs\" />\n\t\t\t<div className=\"flex flex-col gap-4\">\n\t\t\t\t<h2 className=\"text-h2\">SQLite Cache:</h2>\n\t\t\t\t{loaderData.cacheKeys.sqlite.map((key) => (\n\t\t\t\t\t<CacheKeyRow\n\t\t\t\t\t\tkey={key}\n\t\t\t\t\t\tcacheKey={key}\n\t\t\t\t\t\tinstance={instance}\n\t\t\t\t\t\ttype=\"sqlite\"\n\t\t\t\t\t/>\n\t\t\t\t))}\n\t\t\t</div>\n\t\t</div>\n\t)\n}\n\nfunction CacheKeyRow({\n\tcacheKey,\n\tinstance,\n\ttype,\n}: {\n\tcacheKey: string\n\tinstance?: string\n\ttype: 'sqlite' | 'lru'\n}) {\n\tconst fetcher = useFetcher<typeof action>()\n\tconst dc = useDoubleCheck()\n\tconst encodedKey = encodeURIComponent(cacheKey)\n\tconst valuePage = `/admin/cache/${type}/${encodedKey}?instance=${instance}`\n\treturn (\n\t\t<div className=\"flex items-center gap-2 font-mono\">\n\t\t\t<fetcher.Form method=\"POST\">\n\t\t\t\t<input type=\"hidden\" name=\"cacheKey\" value={cacheKey} />\n\t\t\t\t<input type=\"hidden\" name=\"instance\" value={instance} />\n\t\t\t\t<input type=\"hidden\" name=\"type\" value={type} />\n\t\t\t\t<Button\n\t\t\t\t\tsize=\"sm\"\n\t\t\t\t\tvariant=\"secondary\"\n\t\t\t\t\t{...dc.getButtonProps({ type: 'submit' })}\n\t\t\t\t>\n\t\t\t\t\t{fetcher.state === 'idle'\n\t\t\t\t\t\t? dc.doubleCheck\n\t\t\t\t\t\t\t? 'You sure?'\n\t\t\t\t\t\t\t: 'Delete'\n\t\t\t\t\t\t: 'Deleting...'}\n\t\t\t\t</Button>\n\t\t\t</fetcher.Form>\n\t\t\t<Link reloadDocument to={valuePage}>\n\t\t\t\t{cacheKey}\n\t\t\t</Link>\n\t\t</div>\n\t)\n}\n\nexport function ErrorBoundary() {\n\treturn (\n\t\t<GeneralErrorBoundary\n\t\t\tstatusHandlers={{\n\t\t\t\t403: ({ error }) => (\n\t\t\t\t\t<p>You are not allowed to do that: {error?.data.message}</p>\n\t\t\t\t),\n\t\t\t}}\n\t\t/>\n\t)\n}\n"],"names":["handle","getSitemapEntries","cache","_UNSAFE_withComponentProps","loaderData","searchParams","useSearchParams","submit","useSubmit","query","get","limit","instance","handleFormChange","useDebounce","form","jsxs","className","children","jsx","Spacer","size","Form","method","onChange","e","currentTarget","type","Field","labelProps","inputProps","name","defaultValue","title","cacheKeys","sqlite","length","lru","step","min","max","placeholder","Object","entries","instances","map","inst","region","value","currentInstanceInfo","currentInstance","primaryInstance","filter","Boolean","join","key","CacheKeyRow","cacheKey","fetcher","useFetcher","dc","useDoubleCheck","encodedKey","encodeURIComponent","valuePage","Button","variant","getButtonProps","state","doubleCheck","Link","reloadDocument","to","ErrorBoundary","_UNSAFE_withErrorBoundaryProps","GeneralErrorBoundary","statusHandlers","error","data","message"],"mappings":"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"}